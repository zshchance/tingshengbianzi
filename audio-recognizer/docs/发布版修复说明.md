# 听声辨字 - 发布版问题修复说明

## 🔧 已修复的问题

### 1. ✅ 配置保存到开发环境的问题

**问题描述**：
发布版应用运行时仍然将配置文件保存到开发环境的 `audio-recognizer/config/` 目录，而不是用户独立的位置。

**修复方案**：
- 添加了智能环境检测逻辑 `getUserConfigDirectory()`
- **开发环境**：当应用检测到项目文件（`go.mod`, `wails.json`）时，使用项目配置目录
- **生产环境**：当应用独立部署时，使用用户主目录：
  ```
  ~/Library/Application Support/听声辨字/
  ```

**配置文件位置**：
- 开发环境：`{项目根目录}/config/user-config.json`
- 生产环境：`~/Library/Application Support/听声辨字/user-config.json`

### 2. ✅ 打包时图标被还原的问题

**问题描述**：
每次打包时Wails会重新生成图标，导致自定义图标被还原为默认Wails图标。

**修复方案**：
- 使用原始logo文件重新生成了完整的ICNS图标集
- 更新了主图标文件 `frontend/assets/icons/icon.icns`
- 配置wails.json使用正确的自定义图标路径

**图标文件**：
- 源文件：`frontend/assets/icons/听生辩字logo.png` (1000x1000)
- 生成图标：`frontend/assets/icons/icon.icns` (773KB)
- 应用图标：自动嵌入到应用包中

### 3. ✅ AI模板自动复制机制

**新增功能**：
- 生产环境首次运行时，自动将内置的AI模板复制到用户配置目录
- 确保用户即使没有用户模板文件也能使用所有AI优化功能

## 🚀 独立发布版本使用方法

### 安装应用
```bash
# 方法1：复制到Applications目录
cp -r tingshengbianzi.app /Applications/

# 方法2：双击安装
# 双击 tingshengbianzi.app 并按提示安装
```

### 首次使用配置
1. **启动应用**：双击应用图标或从Launchpad启动
2. **下载Whisper模型**：
   ```bash
   # 如果有用户模板目录，运行：
   ./download-models.sh base
   ```
3. **配置设置**：
   - 点击设置按钮（⚙️）
   - 设置模型路径指向包含模型文件的目录
   - 选择识别语言和其他参数

### 配置文件位置
生产环境用户的配置数据保存在：
```
📁 ~/Library/Application Support/听声辨字/
├── 📄 user-config.json      # 主配置文件
├── 📄 templates.json        # AI优化模板
└── 📁 models/               # Whisper模型目录
    └── 📁 whisper/
        └── 📄 ggml-base.bin  # 下载的模型文件
```

## 📋 验证修复效果

### 1. 验证配置独立性
```bash
# 在开发目录运行，配置应保存在项目目录
./build/bin/tingshengbianzi.app/Contents/MacOS/tingshengbianzi
# 输出应显示：配置文件路径指向项目目录

# 在独立目录运行，配置应保存在用户目录
cp -r build/bin/tingshengbianzi.app /tmp/ && open /tmp/tingshengbianzi.app
# 配置应创建在 ~/Library/Application Support/听声辨字/
```

### 2. 验证图标显示
```bash
# 清理图标缓存
killall Dock
rm -rf ~/Library/Caches/com.apple.iconservices.store

# 启动应用检查Dock中的图标
open tingshengbianzi.app
```

### 3. 验证AI模板
首次启动时应用应输出：
```
✅ 已复制内置模板到用户目录: ~/Library/Application Support/听声辨字/templates.json
```

## 🔄 开发与生产环境自动切换

应用会自动检测运行环境：

- **开发环境**（检测到 `go.mod` + `wails.json`）：
  - 配置保存到项目目录
  - 模板路径指向项目配置
  - 便于开发和调试

- **生产环境**（独立部署）：
  - 配置保存到用户主目录
  - 自动复制内置模板到用户目录
  - 确保用户数据独立和安全

## 📦 发布包内容

当前发布包包含：
- `tingshengbianzi.app` - 主应用程序（8.1MB，含自定义图标）
- 所有依赖已内置（FFmpeg fallback机制）
- 自动配置管理
- 完整的音频识别和AI优化功能

## 🎯 使用建议

1. **用户安装**：推荐将应用安装到 `/Applications/` 目录
2. **模型下载**：首次使用前下载Whisper模型文件
3. **配置管理**：所有设置自动保存，支持导入/导出
4. **问题排查**：删除用户配置目录可恢复默认设置

---

**修复完成时间**：2025年11月18日
**版本**：v2.0.0 独立发布版
**状态**：✅ 所有问题已修复，可正常使用